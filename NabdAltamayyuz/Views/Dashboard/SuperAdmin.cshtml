@model IEnumerable<NabdAltamayyuz.Models.Company>
@using System.Globalization

@{
    var isRtl = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isRtl ? "لوحة القيادة العليا" : "Super Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var companiesCount = ViewBag.CompaniesCount ?? 0;
    var employeesCount = ViewBag.EmployeesCount ?? 0;

    var companiesList = Model.ToList();
    var expiringCompanies = companiesList.Where(c => !c.IsSuspended && (c.SubscriptionEndDate - DateTime.Now).Days <= c.NotificationDaysBeforeExpiry).ToList();
}

<div class="container py-5 animate-fade-in" style="margin-top: 120px;">
    <!-- Welcome Header -->
    <div class="row mb-5 align-items-end">
        <div class="col-lg-8">
            <h6 class="text-gold text-uppercase fw-bold letter-spacing-1 mb-2">@(isRtl ? "نظرة عامة على النظام" : "System Overview")</h6>
            <h2 class="fw-bold text-dark display-5">
                @(isRtl ? "مرحباً،" : "Hello,") <span class="text-primary-gradient">@(isRtl ? "المالك" : "Super Admin")</span>
            </h2>
        </div>
        <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
            <a href="/Companies/Create" class="btn btn-gold bg-dark text-gold fw-bold shadow-lg rounded-pill px-4 hover-scale">
                <i class="fas fa-plus-circle me-2"></i> @(isRtl ? "إضافة شركة" : "Add Company")
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100 rounded-4 bg-dark text-white">
                <div class="card-body p-4 position-relative">
                    <div class="position-absolute top-0 end-0 p-3 opacity-10"><i class="fas fa-building fa-4x text-gold"></i></div>
                    <h3 class="fw-bold mb-1">@companiesCount</h3>
                    <p class="text-white-50 small mb-0">@(isRtl ? "إجمالي الشركات" : "Total Companies")</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100 rounded-4 bg-white">
                <div class="card-body p-4">
                    <h3 class="fw-bold mb-1 text-dark">@employeesCount</h3>
                    <p class="text-muted small mb-0">@(isRtl ? "إجمالي الموظفين" : "Total Employees")</p>
                </div>
            </div>
        </div>

        <!-- Alerts Card -->
        <div class="col-xl-6">
            <div class="card border-0 shadow-sm h-100 rounded-4 bg-gold-light border-start border-5 border-warning">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="icon-box bg-warning text-dark rounded-circle p-3 me-3"><i class="fas fa-bell fa-lg"></i></div>
                    <div>
                        <h6 class="fw-bold text-dark mb-1">@(isRtl ? "تنبيهات الاشتراكات" : "Subscription Alerts")</h6>
                        <p class="small mb-0 text-muted">
                            @(isRtl ? "يوجد" : "There are")
                            <span class="fw-bold text-danger">@expiringCompanies.Count</span>
                            @(isRtl ? "شركات قاربت اشتراكاتها على الانتهاء" : "companies with expiring subscriptions")
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <!-- Main Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100">
                <div class="card-header bg-white py-4 px-4 border-bottom">
                    <h5 class="fw-bold mb-0 text-dark">@(isRtl ? "تحليل النمو (الشركات والموظفين)" : "Growth Analysis (Companies & Employees)")</h5>
                </div>
                <div class="card-body p-4">
                    <canvas id="growthChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Distribution Chart -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden h-100">
                <div class="card-header bg-white py-4 px-4 border-bottom">
                    <h5 class="fw-bold mb-0 text-dark">@(isRtl ? "حالة الاشتراكات" : "Subscription Status")</h5>
                </div>
                <div class="card-body p-4 d-flex justify-content-center align-items-center">
                    <div style="width: 250px; height: 250px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Companies List (Simplified) -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="card-header bg-white py-4 px-4 border-bottom">
            <h5 class="fw-bold mb-0 text-dark">@(isRtl ? "آخر الشركات المسجلة" : "Recent Companies")</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="px-4">@(isRtl ? "الشركة" : "Company")</th>
                            <th>@(isRtl ? "المسؤول" : "Responsible")</th>
                            <th>@(isRtl ? "تاريخ الاشتراك" : "Subscription Date")</th>
                            <th>@(isRtl ? "الحالة" : "Status")</th>
                            <th class="text-end px-4">@(isRtl ? "إجراءات" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (companiesList.Any())
                        {
                            foreach (var item in companiesList.Take(5))
                            {
                                var daysLeft = (item.SubscriptionEndDate - DateTime.Now).Days;
                                var statusBadge = item.IsSuspended ? "bg-danger" : (daysLeft < item.NotificationDaysBeforeExpiry ? "bg-warning text-dark" : "bg-success");
                                var statusText = item.IsSuspended ? (isRtl ? "معلق" : "Suspended") : (daysLeft < 0 ? (isRtl ? "منتهي" : "Expired") : (isRtl ? "نشط" : "Active"));

                                <tr>
                                    <td class="px-4"><span class="fw-bold text-dark">@item.Name</span></td>
                                    <td>@item.ResponsiblePerson</td>
                                    <td>@item.SubscriptionStartDate.ToString("yyyy-MM-dd")</td>
                                    <td><span class="badge @statusBadge rounded-pill px-3">@statusText</span></td>
                                    <td class="text-end px-4">
                                        <a href="/Companies/Details/@item.Id" class="btn btn-sm btn-outline-info rounded-circle"><i class="fas fa-eye"></i></a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Growth Chart (Line)
        var ctxGrowth = document.getElementById('growthChart').getContext('2d');
        var growthChart = new Chart(ctxGrowth, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: '@(isRtl ? "الشركات" : "Companies")',
                    data: [5, 8, 12, 15, 20, @companiesCount],
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                }, {
                    label: '@(isRtl ? "الموظفين" : "Employees")',
                    data: [20, 45, 80, 110, 150, @employeesCount],
                    borderColor: '#0F172A',
                    backgroundColor: 'rgba(15, 23, 42, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                maintainAspectRatio: false
            }
        });

        // Status Chart (Doughnut)
        var ctxStatus = document.getElementById('statusChart').getContext('2d');
        var statusChart = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: [
                    '@(isRtl ? "نشط" : "Active")',
                    '@(isRtl ? "منتهي/قريب" : "Expired/Near")',
                    '@(isRtl ? "معلق" : "Suspended")'
                ],
                datasets: [{
                    data: [
                        @companiesList.Count(c => !c.IsSuspended && (c.SubscriptionEndDate - DateTime.Now).Days > 30),
                        @companiesList.Count(c => !c.IsSuspended && (c.SubscriptionEndDate - DateTime.Now).Days <= 30),
                        @companiesList.Count(c => c.IsSuspended)
                    ],
                    backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: { legend: { position: 'bottom' } }
            }
        });
    });
</script>
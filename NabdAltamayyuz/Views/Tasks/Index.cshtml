@model IEnumerable<NabdAltamayyuz.Models.WorkTask>
@using System.Globalization
@using NabdAltamayyuz.Models

@{
    var isRtl = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isRtl ? "إدارة المهام" : "Tasks Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isEmployee = User.IsInRole(UserRole.Employee.ToString());

    // Stats for Meter
    int total = ViewBag.TotalTasks ?? 0;
    int completed = ViewBag.CompletedTasks ?? 0;
    int pending = ViewBag.PendingTasks ?? 0;
    int delayed = ViewBag.DelayedTasks ?? 0;
    double progress = total > 0 ? (double)completed / total * 100 : 0;
}

<div class="container py-5 animate-fade-in" style="margin-top: 120px;">

    <!-- Metrics Bar (مقياس الإنجاز) -->
    <div class="row g-3 mb-4 no-print">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-dark text-white h-100 rounded-3">
                <div class="card-body p-3 d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-gold mb-1">@(isRtl ? "نسبة الإنجاز" : "Completion Rate")</h6>
                        <h3 class="fw-bold mb-0 text-black">@Math.Round(progress, 1)%</h3>
                    </div>
                    <div style="width: 50px; height: 50px;">
                        <svg viewBox="0 0 36 36" class="circular-chart gold">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle" stroke-dasharray="@progress, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-white h-100 rounded-3 border-start border-4 border-success">
                <div class="card-body p-3">
                    <small class="text-muted fw-bold">@(isRtl ? "المنجزة" : "Completed")</small>
                    <h4 class="fw-bold text-dark mb-0">@completed</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-white h-100 rounded-3 border-start border-4 border-warning">
                <div class="card-body p-3">
                    <small class="text-muted fw-bold">@(isRtl ? "المؤجلة / قيد الانتظار" : "Pending / Delayed")</small>
                    <h4 class="fw-bold text-dark mb-0">@pending</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-white h-100 rounded-3 border-start border-4 border-danger">
                <div class="card-body p-3">
                    <small class="text-muted fw-bold">@(isRtl ? "المتأخرة" : "Late")</small>
                    <h4 class="fw-bold text-dark mb-0">@delayed</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Title & Actions -->
    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
        <h4 class="fw-bold text-dark"><i class="fas fa-list-check text-gold me-2"></i> @(isRtl ? "سجل المهام" : "Tasks Log")</h4>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-outline-secondary btn-sm rounded-pill px-3"><i class="fas fa-print me-1"></i> @(isRtl ? "طباعة" : "Print")</button>
            <button onclick="exportToExcel('tasksTable')" class="btn btn-outline-success btn-sm rounded-pill px-3"><i class="fas fa-file-excel me-1"></i> Excel</button>
            @if (!isEmployee)
            {
                <a href="/Tasks/Create" class="btn btn-gold bg-dark text-gold fw-bold rounded-pill px-4 shadow-sm hover-scale">
                    <i class="fas fa-plus-circle me-2"></i> @(isRtl ? "إسناد مهمة" : "Assign Task")
                </a>
            }
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white no-print">
        <div class="card-body p-3">
            <form method="get" class="row g-2 align-items-end">
                @if (!isEmployee)
                {
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold ms-1">@(isRtl ? "الشركة / الفرع" : "Company / Branch")</label>
                        <select name="companyId" class="form-select bg-light border-0" asp-items="ViewBag.Companies">
                            <option value="">@(isRtl ? "-- الكل --" : "-- All --")</option>
                        </select>
                    </div>
                }
                <div class="col-md-3">
                    <label class="small text-muted fw-bold ms-1">@(isRtl ? "بحث" : "Search")</label>
                    <input type="text" name="searchString" class="form-control bg-light border-0" placeholder="@(isRtl ? "عنوان المهمة / الموظف" : "Task Title / Employee")" value="@ViewBag.CurrentSearch">
                </div>
                <div class="col-md-2">
                    <label class="small text-muted fw-bold ms-1">@(isRtl ? "الحالة" : "Status")</label>
                    <select name="status" class="form-select bg-light border-0" asp-items="Html.GetEnumSelectList<NabdAltamayyuz.Models.TaskStatus>()">
                        <option value="">@(isRtl ? "-- الكل --" : "-- All --")</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted fw-bold ms-1">@(isRtl ? "من تاريخ" : "From Date")</label>
                    <input type="date" name="fromDate" class="form-control bg-light border-0" value="@ViewBag.FromDate">
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-dark rounded-pill">@(isRtl ? "عرض" : "Filter")</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tasks Table (Sijill) -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="tasksTable" class="table table-hover align-middle mb-0 text-center">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4 text-start">@(isRtl ? "عنوان المهمة" : "Task Title")</th>
                            <th>@(isRtl ? "الموظف" : "Employee")</th>
                            @if (!isEmployee)
                            {
                                <th>@(isRtl ? "الشركة / الفرع" : "Company / Branch")</th>
                            }
                            <th>@(isRtl ? "تاريخ الاستحقاق (من - إلى)" : "Due Date (From - To)")</th>
                            <th>@(isRtl ? "الحالة" : "Status")</th>
                            <th class="text-end pe-4 no-print">@(isRtl ? "الإجراءات" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                var statusClass = item.Status switch
                                {
                                    NabdAltamayyuz.Models.TaskStatus.Completed => "bg-success bg-opacity-10 text-success",
                                    NabdAltamayyuz.Models.TaskStatus.Pending => "bg-warning bg-opacity-10 text-dark",
                                    NabdAltamayyuz.Models.TaskStatus.Delayed => "bg-info bg-opacity-10 text-dark",
                                    NabdAltamayyuz.Models.TaskStatus.Cancelled => "bg-danger bg-opacity-10 text-danger",
                                    _ => "bg-secondary"
                                };

                                <tr>
                                    <td class="text-start ps-4 fw-bold text-dark">@item.Title</td>
                                    <td>@item.AssignedTo?.FullName</td>
                                    @if (!isEmployee)
                                    {
                                        <td class="small">@(item.AssignedTo?.Company?.Name ?? "-")</td>
                                    }
                                    <td class="small font-monospace">
                                        <div class="text-muted">@item.StartDate.ToString("dd/MM/yyyy")</div>
                                        <div class="text-danger fw-bold">@item.DueDate.ToString("dd/MM/yyyy")</div>
                                    </td>
                                    <td><span class="badge @statusClass rounded-pill px-3">@item.Status</span></td>
                                    <td class="text-end pe-4 no-print">
                                        <div class="btn-group">
                                            <a href="/Tasks/Details/@item.Id" class="btn btn-sm btn-outline-info rounded-circle" title="@(isRtl ? "معاينة" : "View")"><i class="fas fa-eye"></i></a>
                                            @if (!isEmployee || (!item.IsCompleted))
                                            {
                                                <a href="/Tasks/Edit/@item.Id" class="btn btn-sm btn-outline-primary rounded-circle" title="@(isRtl ? "تعديل" : "Edit")"><i class="fas fa-edit"></i></a>
                                            }
                                            @if (!isEmployee)
                                            {
                                                <form action="/Tasks/Delete" method="post" style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@item.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-circle" onclick="return confirm('@(isRtl ? "حذف المهمة؟" : "Delete Task?")')" title="@(isRtl ? "حذف" : "Delete")"><i class="fas fa-trash-alt"></i></button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="@(isEmployee ? 5 : 6)" class="py-5 text-muted">@(isRtl ? "لا توجد مهام" : "No tasks found")</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .circular-chart {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        max-height: 250px;
    }

    .circle-bg {
        fill: none;
        stroke: #eee;
        stroke-width: 3.8;
    }

    .circle {
        fill: none;
        stroke-width: 2.8;
        stroke-linecap: round;
        animation: progress 1s ease-out forwards;
    }

    .circular-chart.gold .circle {
        stroke: #D4AF37;
    }

    @@keyframes progress {
        0% {
            stroke-dasharray: 0 100;
        }
    }
</style>

@section Scripts {
    <script>
        function exportToExcel(tableId) {
            var table = document.getElementById(tableId);
            var clone = table.cloneNode(true);
            // Clean up for export
            var rows = clone.rows;
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                for (var j = cells.length - 1; j >= 0; j--) {
                    if (cells[j].classList.contains('no-print')) rows[i].deleteCell(j);
                }
            }
            var html = clone.outerHTML;
            var blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href = url; a.download = 'Tasks_Log.xls'; a.click();
        }
    </script>
}
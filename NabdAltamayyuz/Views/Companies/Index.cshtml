@model IEnumerable<NabdAltamayyuz.Models.Company>
@using System.Globalization
@using NabdAltamayyuz.Models

@{
    var isRtl = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isRtl ? "إدارة الشركات" : "Companies Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isSuperAdmin = User.IsInRole("SuperAdmin");
    bool isCompanyAdmin = User.IsInRole("CompanyAdmin");
    string currentFilter = ViewBag.CurrentFilter as string;
    string statusFilter = ViewBag.StatusFilter as string;
}

<div class="container py-5 animate-fade-in" style="margin-top: 100px;">

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h3 class="fw-bold text-dark"><i class="fas fa-building text-gold me-2"></i> @(isRtl ? "سجل الشركات" : "Companies Registry")</h3>
            <p class="text-muted small mb-0">@(isRtl ? "إدارة السجلات الرئيسية والفرعية" : "Manage Main & Sub Records")</p>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-outline-secondary btn-sm rounded-pill px-3"><i class="fas fa-print me-1"></i> @(isRtl ? "طباعة" : "Print")</button>
            <button onclick="exportToExcel('companiesTable')" class="btn btn-outline-success btn-sm rounded-pill px-3"><i class="fas fa-file-excel me-1"></i> Excel</button>

            @if (isSuperAdmin)
            {
                <a href="/Companies/Create" class="btn btn-gold bg-dark text-gold fw-bold rounded-pill px-4 shadow-sm hover-scale">
                    <i class="fas fa-plus-circle me-2"></i> @(isRtl ? "إضافة شركة" : "Add Company")
                </a>
            }
            @if (isCompanyAdmin)
            {
                <a href="/Companies/CreateSub" class="btn btn-gold bg-dark text-gold fw-bold rounded-pill px-4 shadow-sm hover-scale">
                    <i class="fas fa-code-branch me-2"></i> @(isRtl ? "إضافة فرع" : "Add Branch")
                </a>
            }
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white no-print">
        <div class="card-body p-3">
            <form method="get" action="/Companies/Index" class="row g-2 align-items-center">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" name="searchString" class="form-control bg-light border-0" placeholder="@(isRtl ? "بحث باسم الشركة..." : "Search company name...")" value="@currentFilter">
                    </div>
                </div>
                <div class="col-md-3">
                    <select name="statusFilter" class="form-select bg-light border-0">
                        <option value="">@(isRtl ? "-- كل الحالات --" : "-- All Statuses --")</option>
                        <option value="Active" selected="@(statusFilter == "Active")">@(isRtl ? "نشط" : "Active")</option>
                        <option value="Suspended" selected="@(statusFilter == "Suspended")">@(isRtl ? "معلق" : "Suspended")</option>
                        <option value="Expired" selected="@(statusFilter == "Expired")">@(isRtl ? "منتهي" : "Expired")</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100 rounded-pill">@(isRtl ? "بحث" : "Search")</button>
                </div>
                <div class="col-md-2">
                    <a href="/Companies/Index" class="btn btn-light w-100 rounded-pill border">@(isRtl ? "إلغاء" : "Clear")</a>
                </div>
            </form>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success border-0 bg-success bg-opacity-10 text-success rounded-3 mb-4"><i class="fas fa-check-circle me-2"></i> @TempData["Success"]</div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger rounded-3 mb-4"><i class="fas fa-exclamation-circle me-2"></i> @TempData["Error"]</div>
    }

    <!-- Table -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="companiesTable" class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4 no-export" style="width: 40px;"></th>
                            <th>@(isRtl ? "الشركة" : "Company")</th>
                            <th>@(isRtl ? "الموظفين (فعلي/مسموح)" : "Employees (Act/All)")</th>
                            <th>@(isRtl ? "الفروع (فعلي/مسموح)" : "Branches (Act/All)")</th>
                            <th>@(isRtl ? "الحالة" : "Status")</th>
                            <th class="text-end pe-4 no-export">@(isRtl ? "الإجراءات" : "Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                var daysLeft = (item.SubscriptionEndDate - DateTime.Now).Days;
                                var statusBadge = item.IsSuspended ? "bg-danger" : (daysLeft < 0 ? "bg-secondary" : "bg-success");
                                var statusText = item.IsSuspended ? (isRtl ? "معلق" : "Suspended") : (daysLeft < 0 ? (isRtl ? "منتهي" : "Expired") : (isRtl ? "نشط" : "Active"));
                                var hasBranches = item.SubCompanies != null && item.SubCompanies.Any();

                                var actualEmployees = item.Employees?.Count(e => e.Role == UserRole.Employee) ?? 0;
                                var actualBranches = item.SubCompanies?.Count ?? 0;

                                <!-- Main Company -->
                                <tr class="bg-white">
                                    <td class="ps-4 no-export">
                                        @if (hasBranches)
                                        {
                                            <button class="btn btn-sm btn-light rounded-circle text-gold fw-bold toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#sub-@item.Id">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        }
                                    </td>
                                    <td class="fw-bold text-dark">@item.Name</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@actualEmployees / @item.AllowedEmployees</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@actualBranches / @item.AllowedSubAccounts</span>
                                    </td>
                                    <td><span class="badge @statusBadge rounded-pill px-3">@statusText</span></td>
                                    <td class="text-end pe-4 no-export">
                                        <div class="btn-group">
                                            @if (isSuperAdmin)
                                            {
                                                <a href="/Companies/CreateSub?parentId=@item.Id" class="btn btn-sm btn-gold text-dark" title="@(isRtl ? "إضافة فرع" : "Add Branch")"><i class="fas fa-code-branch"></i></a>
                                            }
                                            <a href="/Companies/Edit/@item.Id" class="btn btn-sm btn-outline-primary" title="@(isRtl ? "تعديل" : "Edit")"><i class="fas fa-edit"></i></a>
                                            <a href="/Companies/Details/@item.Id" class="btn btn-sm btn-outline-info" title="@(isRtl ? "تفاصيل" : "Details")"><i class="fas fa-eye"></i></a>
                                            <button onclick="suspendCompany(@item.Id)" class="btn btn-sm btn-outline-warning" title="@(isRtl ? "تعليق/تفعيل" : "Suspend/Activate")"><i class="fas @(item.IsSuspended ? "fa-play" : "fa-pause")"></i></button>
                                            @if (isSuperAdmin)
                                            {
                                                <a href="/Companies/Delete/@item.Id" class="btn btn-sm btn-outline-danger" title="@(isRtl ? "حذف" : "Delete")" onclick="return confirm('@(isRtl ? "هل أنت متأكد من حذف الشركة؟" : "Are you sure you want to delete this company?")')"><i class="fas fa-trash"></i></a>
                                            }
                                        </div>
                                    </td>
                                </tr>

                                <!-- Sub Companies (Tree View) -->
                                @if (hasBranches)
                                {
                                    <tr class="collapse bg-light border-bottom no-export" id="sub-@item.Id">
                                        <td colspan="6" class="p-0">
                                            <div class="p-3 ps-5">
                                                <h6 class="text-gold small fw-bold mb-2 ms-4"><i class="fas fa-share fa-flip-vertical me-2"></i> @(isRtl ? "الفروع:" : "Branches:")</h6>
                                                <table class="table table-sm table-borderless mb-0 ms-4 w-75">
                                                    <tbody>
                                                        @foreach (var sub in item.SubCompanies)
                                                        {
                                                            var subEmps = sub.Employees?.Count(e => e.Role == UserRole.Employee) ?? 0;
                                                            <tr>
                                                                <td width="30%" class="fw-bold text-dark"><i class="fas fa-circle text-gold me-2" style="font-size:6px;"></i> @sub.Name</td>
                                                                <td width="20%">@(isRtl ? "موظفين" : "Employees"): @subEmps / @sub.AllowedEmployees</td>
                                                                <td width="30%" class="text-end">
                                                                    <a href="/Companies/Edit/@sub.Id" class="text-primary small me-2 text-decoration-none"><i class="fas fa-edit"></i> @(isRtl ? "تعديل" : "Edit")</a>
                                                                    @if (isSuperAdmin)
                                                                    {
                                                                        <a href="/Companies/Delete/@sub.Id" class="text-danger small me-2 text-decoration-none" onclick="return confirm('@(isRtl ? "هل أنت متأكد من حذف الفرع؟" : "Are you sure you want to delete this branch?")')"><i class="fas fa-trash"></i> @(isRtl ? "حذف" : "Delete")</a>
                                                                    }
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                        else
                        {
                            <tr><td colspan="6" class="text-center py-5 text-muted">@(isRtl ? "لا توجد سجلات" : "No records found")</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function suspendCompany(id) {
            var confirmMsg = '@(isRtl ? "هل أنت متأكد من تغيير حالة تعليق الحساب؟" : "Are you sure you want to change account suspension status?")';
            if(confirm(confirmMsg)) {
                fetch('/Companies/Suspend/' + id, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value }
                }).then(res => res.json()).then(data => {
                    if(data.success) {
                        location.reload();
                    } else {
                        alert('@(isRtl ? "خطأ: " : "Error: ")' + data.message);
                    }
                });
            }
        }

        function exportToExcel(tableId) {
            var table = document.getElementById(tableId);
            var clone = table.cloneNode(true);
            var rows = clone.rows;
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                for (var j = cells.length - 1; j >= 0; j--) {
                    if (cells[j].classList.contains('no-export')) rows[i].deleteCell(j);
                }
            }
            var html = clone.outerHTML;
            var blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href = url; a.download = 'Companies.xls'; a.click();
        }

        $('.toggle-btn').click(function() { $(this).find('i').toggleClass('fa-plus fa-minus'); });
    </script>
}